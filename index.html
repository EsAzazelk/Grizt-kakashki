<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Чат</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        input, button { padding: 10px; margin: 5px 0; width: 100%; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin: 20px 0; }
        .message { margin: 5px 0; padding: 8px; background: #f0f0f0; border-radius: 4px; }
        .auth-section, .chat-section { display: none; }
        .active { display: block; }
    </style>
</head>
<body>
    <!-- Секция аутентификации -->
    <div id="authSection" class="auth-section active">
        <h2>Вход / Регистрация</h2>
        <input id="nickname" placeholder="Ваш ник">
        <input id="password" type="password" placeholder="Пароль">
        <button id="loginBtn">Войти</button>
        <button id="registerBtn">Зарегистрироваться</button>
        <p id="authError" style="color: red;"></p>
    </div>

    <!-- Секция чата -->
    <div id="chatSection" class="chat-section">
        <h2>Чат</h2>
        <p>Вы вошли как: <span id="currentUser"></span></p>
        <input id="receiverNickname" placeholder="Ник получателя">
        <input id="messageInput" placeholder="Ваше сообщение">
        <button id="sendBtn">Отправить</button>
        <div id="messages"></div>
        <button id="logoutBtn">Выйти</button>
    </div>

    <!-- Firebase + Скрипт -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            onSnapshot,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Твоя конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCqvqj2JjGssV2qPYlYD7SosF5WHamFR8Y",
            authDomain: "clicertop.firebaseapp.com",
            projectId: "clicertop",
            storageBucket: "clicertop.firebasestorage.app",
            messagingSenderId: "471596068823",
            appId: "1:471596068823:web:d3af56a21268cdcae5e592"
        };

        // Инициализация Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Элементы DOM
        const authSection = document.getElementById('authSection');
        const chatSection = document.getElementById('chatSection');
        const nicknameInput = document.getElementById('nickname');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const authError = document.getElementById('authError');
        const currentUserSpan = document.getElementById('currentUser');
        const receiverNicknameInput = document.getElementById('receiverNickname');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesDiv = document.getElementById('messages');
        const logoutBtn = document.getElementById('logoutBtn');

        // Показать/скрыть секции
        function toggleSections(isAuth) {
            authSection.classList.toggle('active', isAuth);
            chatSection.classList.toggle('active', !isAuth);
        }

        // Регистрация
        registerBtn.addEventListener('click', async () => {
            const nickname = nicknameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!nickname || !password) {
                authError.textContent = "Заполните все поля!";
                return;
            }

            try {
                // Создаем пользователя с email в формате "ник@chat.com"
                const userCredential = await createUserWithEmailAndPassword(
                    auth, 
                    `${nickname}@chat.com`, 
                    password
                );
                
                // Сохраняем ник в Firestore
                await addDoc(collection(db, "users"), {
                    uid: userCredential.user.uid,
                    nickname: nickname
                });

                toggleSections(false);
                currentUserSpan.textContent = nickname;
            } catch (error) {
                authError.textContent = `Ошибка: ${error.message}`;
            }
        });

        // Вход
        loginBtn.addEventListener('click', async () => {
            const nickname = nicknameInput.value.trim();
            const password = passwordInput.value.trim();

            try {
                await signInWithEmailAndPassword(
                    auth, 
                    `${nickname}@chat.com`, 
                    password
                );
                
                toggleSections(false);
                currentUserSpan.textContent = nickname;
            } catch (error) {
                authError.textContent = `Ошибка: ${error.message}`;
            }
        });

        // Отправка сообщения
        sendBtn.addEventListener('click', async () => {
            const receiverNick = receiverNicknameInput.value.trim();
            const text = messageInput.value.trim();

            if (!receiverNick || !text) return;

            try {
                // Находим получателя по нику
                const usersQuery = query(
                    collection(db, "users"), 
                    where("nickname", "==", receiverNick)
                );
                
                // В реальном приложении нужна пагинация (здесь берем первого)
                const querySnapshot = await getDocs(usersQuery);
                if (querySnapshot.empty) {
                    alert("Пользователь не найден!");
                    return;
                }

                const receiver = querySnapshot.docs[0].data();
                
                // Сохраняем сообщение
                await addDoc(collection(db, "messages"), {
                    from: auth.currentUser.uid,
                    to: receiver.uid,
                    text: text,
                    timestamp: serverTimestamp()
                });

                messageInput.value = "";
            } catch (error) {
                console.error("Ошибка отправки:", error);
            }
        });

        // Выход
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
            toggleSections(true);
        });

        // Отслеживание состояния аутентификации
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Подгружаем ник текущего пользователя
                const userQuery = query(
                    collection(db, "users"),
                    where("uid", "==", user.uid)
                );
                
                onSnapshot(userQuery, (snapshot) => {
                    if (!snapshot.empty) {
                        const userData = snapshot.docs[0].data();
                        currentUserSpan.textContent = userData.nickname;
                    }
                });

                // Слушаем входящие сообщения
                const messagesQuery = query(
                    collection(db, "messages"),
                    where("to", "==", user.uid)
                );
                
                onSnapshot(messagesQuery, (snapshot) => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === "added") {
                            const msg = change.doc.data();
                            displayMessage(msg);
                        }
                    });
                });
            }
        });

        // Отображение сообщения
        function displayMessage(msg) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            // Здесь нужно подгрузить ник отправителя (для краткости просто выводим текст)
            messageDiv.textContent = msg.text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>
